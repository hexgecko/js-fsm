var FSM=function(b){if("string"!==typeof b)throw"FSM:constructor(defaultState: missing the argument defaultState!";this._action={};this._actionRegExp=[];this._lastState=this._currentState=b;this._runAction=!1;this._stalledEvents=[];this._hookStateUpdateCallback=this._hookTableUpdateCallback=this._hookErrorMissingEventCallback=void 0;this._scope={}};
FSM.prototype.append=function(b){if("function"!==typeof b)throw"FSM:append(callback): callback given as arument is not a function!";var a=b.call(this,this._scope);if(void 0!==a){if(!(a instanceof Array))throw"FSM:append(callback): state table returned by the scope function is not an array!";b=a.length;for(var d=0;d<b;d++){var e=a[d][0];e instanceof RegExp||void 0!==this._action[e]||(this._action[e]={});e=a[d][2];"<"!==e&&void 0===this._action[e]&&(this._action[e]={})}for(d=0;d<b;d++){var f=a[d],c=
f[0],e=f[1],g=f[2],f=f[3];c instanceof RegExp?this._actionRegExp.push({regExp:c,event:e,next:g,action:f}):this._action[c][e]={next:g,action:f}}b=this._actionRegExp.length;for(d=0;d<b;d++){var c=this._actionRegExp[d],a=c.regExp,e=c.event,g=c.next,f=c.action,h;for(h in this._action)a.test(h)&&void 0===this._action[h][e]&&g!==h&&(this._action[h][e]={next:g,action:f})}void 0!==this._hookTableUpdateCallback&&this._hookTableUpdateCallback(this._action)}};
FSM.prototype.event=function(b){var a=this,d=b,e=function(){var b=Array.prototype.slice.call(arguments);if(!1===a._runAction){var c=a._action[a._currentState];if(void 0===c)throw"FSM:fireEvent(evt): missing state: "+a._currentState;c=c[d];if(void 0===c){if(void 0!==a._hookErrorMissingEventCallback){a._hookErrorMissingEventCallback(a._currentState,d);return}throw"FSM:fireEvent(evt): missing event: "+d+" in current state: "+a._currentState;}void 0!==c.action&&(a._runAction=!0,c.action.apply(this,b),
a._runAction=!1);void 0!==a._hookStateUpdateCallback&&a._hookStateUpdateCallback(a._currentState,d,c.next,c.action);"<"===c.next?(b=a._currentState,a._currentState=a._lastState,a._lastState=b):(a._lastState=a._currentState,a._currentState=c.next);for(;0<a._stalledEvents.length;)b=a._stalledEvents[0],a._stalledEvents.splice(0,1),d=b.evt,e.apply(this,b.args)}else a._stalledEvents.push({evt:d,args:b})};return e};
FSM.prototype.fireEvent=function(b){var a=Array.prototype.slice.call(arguments);a.splice(0,1);this.event(b).apply(this,a)};
FSM.prototype.remove=function(b,a){var d=!1,e=!1;if(b instanceof RegExp){if(void 0===a)for(var f=this._actionRegExp.length,f=f-1;0<=f;f--){var c=this._actionRegExp[f];c.regExp.toString()===b.toString()&&(this._actionRegExp.splice(f,1),d=!0)}else for(f=this._actionRegExp.length,--f;0<=f;f--)if(c=this._actionRegExp[f],c.regExp.toString()===b.toString()&&c.event===a){this._actionRegExp.splice(f,1);d=!0;break}if(!0===d)for(var g in this._action)if(void 0===a)!0===b.test(g)&&(delete this._action[g],e=
!0);else for(var h in this._action[g])!0===b.test(g)&&h===a&&(delete this._action[g][h],e=!0)}else for(g in this._action)if(void 0===a)g===b&&(delete this._action[g],e=!0);else for(h in this._action[g])g===b&&h===a&&(delete this._action[g][h],e=!0);!0===e&&void 0!==this._hookTableUpdateCallback&&this._hookTableUpdateCallback(this._action)};FSM.prototype.hookErrorMissingEvent=function(b){this._hookErrorMissingEventCallback="function"===typeof b?b:void 0};
FSM.prototype.hookTableUpdate=function(b){this._hookTableUpdateCallback="function"===typeof b?b:void 0};FSM.prototype.hookStateUpdate=function(b){this._hookStateUpdateCallback="function"===typeof b?b:void 0};