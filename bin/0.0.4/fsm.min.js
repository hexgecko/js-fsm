var FSM=function(a){if("string"!==typeof a)throw"FSM:constructor(defaultState: missing the argument defaultState!";this._action={};this._actionRegExp=[];this._lastState=this._currentState=a;this._runAction=!1;this._stalledEvents=[];this._hookStateUpdateCallback=this._hookTableUpdateCallback=this._hookErrorMissingEventCallback=void 0};
FSM.prototype.append=function(a){if("function"!==typeof a)throw"FSM:append(scope): scope given as arument is not a function!";var b=a();if(!(b instanceof Array))throw"FSM:append(scope): state table returned by the scope function is not an array!";a=b.length;for(var c=0;c<a;c++){var e=b[c][0];e instanceof RegExp||void 0!==this._action[e]||(this._action[e]={});e=b[c][2];"<"!==e&&void 0===this._action[e]&&(this._action[e]={})}for(c=0;c<a;c++){var d=b[c],g=d[0],e=d[1],f=d[2],d=d[3];g instanceof RegExp?
this._actionRegExp.push({regExp:g,event:e,next:f,action:d}):this._action[g][e]={next:f,action:d}}a=this._actionRegExp.length;for(c=0;c<a;c++){var g=this._actionRegExp[c],b=g.regExp,e=g.event,f=g.next,d=g.action,h;for(h in this._action)b.test(h)&&void 0===this._action[h][e]&&f!==h&&(this._action[h][e]={next:f,action:d})}void 0!==this._hookTableUpdateCallback&&this._hookTableUpdateCallback(this._action)};
FSM.prototype.fireEvent=function(a){if(!1===this._runAction){var b=this._action[this._currentState];if(void 0===b)throw"FSM:fireEvent(evt): missing state: "+this._currentState;b=b[a];if(void 0===b){if(void 0!==this._hookErrorMissingEventCallback){this._hookErrorMissingEventCallback(this._currentState,a);return}throw"FSM:fireEvent(evt): missing event: "+a+" in current state: "+this._currentState;}if(void 0!==b.action){var c=[];1<arguments.length&&(c=Array.prototype.slice.call(arguments),c.splice(0,
1));this._runAction=!0;b.action.apply(b.action,c);this._runAction=!1}void 0!==this._hookStateUpdateCallback&&this._hookStateUpdateCallback(this._currentState,a,b.next,b.action);"<"===b.next?(b=this._currentState,this._currentState=this._lastState,this._lastState=b):(this._lastState=this._currentState,this._currentState=b.next);for(;0<this._stalledEvents.length;)c=this._stalledEvents[0],this._stalledEvents.splice(0,1),FSM.prototype.fireEvent.apply(this,c)}else this._stalledEvents.push(arguments)};
FSM.prototype.remove=function(a,b){var c=!1,e=!1;if(a instanceof RegExp){if(void 0===b)for(var d=this._actionRegExp.length,d=d-1;0<=d;d--){var g=this._actionRegExp[d];g.regExp.toString()===a.toString()&&(this._actionRegExp.splice(d,1),c=!0)}else for(d=this._actionRegExp.length,--d;0<=d;d--)if(g=this._actionRegExp[d],g.regExp.toString()===a.toString()&&g.event===b){this._actionRegExp.splice(d,1);c=!0;break}if(!0===c)for(var f in this._action)if(void 0===b)!0===a.test(f)&&(delete this._action[f],e=
!0);else for(var h in this._action[f])!0===a.test(f)&&h===b&&(delete this._action[f][h],e=!0)}else for(f in this._action)if(void 0===b)f===a&&(delete this._action[f],e=!0);else for(h in this._action[f])f===a&&h===b&&(delete this._action[f][h],e=!0);!0===e&&void 0!==this._hookTableUpdateCallback&&this._hookTableUpdateCallback(this._action)};FSM.prototype.hookErrorMissingEvent=function(a){this._hookErrorMissingEventCallback="function"===typeof a?a:void 0};
FSM.prototype.hookTableUpdate=function(a){this._hookTableUpdateCallback="function"===typeof a?a:void 0};FSM.prototype.hookStateUpdate=function(a){this._hookStateUpdateCallback="function"===typeof a?a:void 0};