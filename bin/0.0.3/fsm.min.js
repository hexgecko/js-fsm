var FSM=function(c){if("string"!==typeof c)throw"FSM:constructor(defaultState: missing the argument defaultState!";this._action={};this._actionRegExp=[];this._lastState=this._currentState=c;this._runAction=!1;this._stalledEvents=[]};
FSM.prototype.append=function(c){if("function"!==typeof c)throw"FSM:append(scope): scope given as arument is not a function!";var a=c();if(!(a instanceof Array))throw"FSM:append(scope): state table returned by the scope function is not an array!";c=a.length;for(var b=0;b<c;b++){var d=a[b][0];d instanceof RegExp||void 0!==this._action[d]||(this._action[d]={});d=a[b][2];"<"!==d&&void 0===this._action[d]&&(this._action[d]={})}for(b=0;b<c;b++){var e=a[b],f=e[0],d=e[1],g=e[2],e=e[3];f instanceof RegExp?
this._actionRegExp.push({regExp:f,event:d,next:g,action:e}):this._action[f][d]={next:g,action:e}}c=this._actionRegExp.length;for(b=0;b<c;b++){var f=this._actionRegExp[b],a=f.regExp,d=f.event,g=f.next,e=f.action,h;for(h in this._action)a.test(h)&&void 0===this._action[h][d]&&g!==h&&(this._action[h][d]={next:g,action:e})}};
FSM.prototype.fireEvent=function(c){if(!1===this._runAction){var a=this._action[this._currentState];if(void 0===a)throw"FSM:fireEvent(evt): missing state: "+this._currentState;a=a[c];if(void 0===a)throw"FSM:fireEvent(evt): missing event: "+c+" in state: "+this._currentState;if(void 0!==a.action){var b=[];1<arguments.length&&(b=Array.prototype.slice.call(arguments),b.splice(0,1));this._runAction=!0;a.action.apply(a.action,b);this._runAction=!1}"<"===a.next?(a=this._currentState,this._currentState=
this._lastState,this._lastState=a):(this._lastState=this._currentState,this._currentState=a.next);for(;0<this._stalledEvents.length;)b=this._stalledEvents[0],this._stalledEvents.splice(0,1),FSM.prototype.fireEvent.apply(this,b)}else this._stalledEvents.push(arguments)};